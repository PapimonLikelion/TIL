### 2023-01-18

## 배포 전략 & 쿠버네티스
- *참고: https://www.redhat.com/ko/topics/containers/what-is-a-kubernetes-cluster*
- **좋은 배포 요건**
  - 자동화
  - 사용자 영향 최소화
  - 빠른 배포 & 빠른 롤백
  - 배포에 대한 기록이 될 것

- **배포 전략**
  - Rolling Update
    - 점진적으로 교체하는 방식
    - 배포/롤백 둘 다 조금 느림
  - Blue/Green 
    - 기존 Blue, 신규 Green
    - 로드밸런서가 포인팅 하는 것 싹 옮겨줌
    - 즉각적인 배포
    - 2배의 리소스를 투입할 수 있는 여건이 필요
  - Canary
    - 일부 서버에서 단계적으로 트래픽 전환
    - 실시간으로 새로운 버전 테스트 가능
    - 트래픽 전환으로 빠른 롤백 가능

- **CI/CD**
  - 어플리케이션을 짧은 주기로 사용자에게 전달하는 것
  - CI: Continuous Integration
  - CD: Continuous Delivery / Deployment
  - 배포 파이프라인 예시
    - start -> build image -> deliver image to image registry -> update tag -> argocd -> sync -> merge branch

- **Docker**
  - 컨테이너 기반의 오픈소스 가상화 플랫폼
  - 환경에 상관없이 어플리케이션 구축/테스트/배포
  - Docker Container
    - 격리된 공간에서 프로세스가 동작함
    - 여러 Container가 동일한 머신에서 실행 가능하며, 커널을 공유함
    - Container 실행에 필요한 파일 및 설정값을 포함함
    - Container는 이미지로 구동
  - Docker image 만드는 법
    - Dockerfile: 자체 DSL 언어를 사용하기
    - jib: Java 어플리케이션을 간단하게 이미지화 할 수 있음
      - Gradle 플러그인으로 사용해보자
    - docker build를 통해 Docker daemon이 레지스트리로 부터 이미지를 가져오고, 이미지를 만듦
    - 만들어진 이미지를 통해 Docker run으로 컨테이너로 띄움

- **쿠버 개요**
  - 쿠버네티스
    - 2014년 구글에서 만든 오픈소스 컨테이너 오케스트레이션
  - Cluster (상위 개념)
    - 어플리케이션 컨테이너를 실행하기 위한 일련의 노드 머신
    - 컨트롤 플레인 및 하나 이상의 노드를 포함하고 있음
    - YAML 파일로 원하는 상태를 지정해주세요
  - 컨트롤 플레인 (Master Node)
    - 어느 어플리케이션을 실행하고 어플리케이션이 어느 컨테이너 이미지를 사용할지 원하는 상태로 유지 관리
    - 컨트롤 플레인은 etcd, controller manager, scheduler, kube apiserver로 이루어짐
      - etcd <-> kube apiserver
      - scheduler <-> kube apiserver
      - controller manager <-> kube apiserver
    - scheduler: 어느 Pod를 어느 Node에 배치할지
    - etcd: 설정값들의 저장소
    - controller manager: 리소스 매니저, Pod 관리자
    - kube apiserver: Node와 소통하는 역할
  - 노드 (Worker Node)
    - 어플리케이션과 워크로드를 실제로 실행
    - 컨테이너는 반드시 Pod안에서 구동됨
    - Node안에 보통 하나의 Pod를 담아 구동시킴
    - 노드는 pod, kubelet으로 구성됨
    - pod: 컨테이너를 구동시킴
    - kubelet: 마스터 노드, 다른 워커 노드와 통신하는 역할 수행

- **쿠버 구성 요소**
  - Object: 템플릿을 통해 리소스의 바라는 상태를 정의해두면 이를 바탕으로 오브젝트 생성/삭제
    - Namespace: 클러스터 내부를 논리적인 단위로 구분해 사용
    - Pod: 쿠버네티스에서 컨테이너가 실행되는 최소 단위
    - Service
  - Controller: Pod 관리하는 역할
    - ReplicaSet: Self-Healing, 가용성 보장
    - Deployment: 무상태 어플리케이션 배포시 사용
    - DaemonSet: 모든 노드에 동일한 파트 실행시 사용
    - StatefulSet: 상태 있는 파드 관리
    - Job: 일회성 작업
    - Cronjob: 주기적 작업
  - Service: Pod가 생성/삭제 되면서 IP 변경될 수 있는데, 이를 고정된 주소로 박아버리는 것을 도와줌
    - ClusterIP: 클러스터 내부에서 접근 가능한 IP 제공
    - NodePort: 노드에 노출되어 외부에서 접근 가능한 서비스
    - LoadBalancer: 외부 로드밸런서 pod에 연결
  - Ingress: 클러스터 내부로 접근하는 요청 어찌 처리할지 정의해둔 규칙
