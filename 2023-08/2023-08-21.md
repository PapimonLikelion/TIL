### 2023-08-21

## Sentry with logback
*참고: https://zorba91.tistory.com/311*
- **필자의 상황**
  - `Sentry.capture()` 를 통해 확인하고 싶은 부분만 메서드로 선언해서 보는 방식
  - 전역적으로 센트리를 적용하고자 했음

- **Sentry 공홈에서 추천하는 적용방식 4가지**
  - *참고: https://docs.sentry.io/platforms/java/configuration/*
  1. `sentry.properties`: `dsn={dsn}`
  2. 시스템 환경변수 적용
  3. 자바 시스템 프로퍼티에 적용: `java -Dsentry.dsn={clientKey} -jar app.jar`
  4. 코드상으로 적용

- **자바 시스템 프로퍼티 vs 시스템 환경변수**
  - 자바 시스템 프로퍼티: 자바 커맨드 라인에 의해 세팅
    - 이를 사용하는 프로세스에서만 해당 변수에 접근 가능
    - `-Dpropertyname=value`
  - 시스템 환경변수: OS에 세팅. 모든 프로세스에서 접근 가능
    - 런타임에 세팅되지 않음

- **해보기**
  - gradle에 디펜던스 넣기
    ```
    compile 'io.sentry:sentry-logback:1.7.30'
    compile 'io.sentry:sentry-spring-boot-starter:1.7.30'
    ```
  - logback-spring.xml에 추가하기
    ```xml
    <?xml version="1.0" encoding="UTF-8" ?>
    <configuration>
        <appender name="Console" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
            </encoder>
        </appender>
        
        <appender name="Sentry" class="io.sentry.logback.SentryAppender">
            <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
                <level>ERROR</level>
            </filter>
            <encoder>
                <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
            </encoder>
        </appender>
        
        <root level="INFO">
            <appender-ref ref="Console" />
            <appender-ref ref="Sentry" />
        </root>
    </configuration>
    ```
    
## SDK
*참고: https://doozi0316.tistory.com/entry/SDK-API%EC%9D%98-%EA%B0%9C%EB%85%90%EA%B3%BC-%EC%B0%A8%EC%9D%B4%EC%A0%90*
*참고: https://reinvite.tistory.com/116*
*참고: https://change-words.tistory.com/entry/API-SDK-%EC%B0%A8%EC%9D%B4*
- **SDK**
  - Software Development Kit
    - 다른 프로그램을 추가하거나 연결할 수 있는 커스텀 앱을 제작할 수 있는 기능을 제공하는 도구
  - API, IDE, 문서, 라이브러리, 코드 샘플, 기타 유틸리티, 디버깅 프로그램 포함
  - SDK는 프로그램 및 응용 프로그램 개발의 복잡성을 줄이는 강력한 기능 집합
  - 미리 만들어진 도구를 제공함으로써 개발 과정을 쉽게
  - examples
    - iOS SDK: iOS 어플리케이션을 만드는데 필요한 모든 도구가 제공됨
    - JDK: 자바 개발자를 대상으로 한 오라클에서 제공하는 도구
    - Andriod SDK: 안드로이드용 앱 개발을 위한 도구

- **SDK vs API**
  - SDK: 망치, 팬치, 니퍼 등이 들어있는 하나의 공구박스
    - "좋아요 기능 만들기 위해 필요한 재료 다 드립니다. 원하는 대로 만들어보쇼"
  - API: 그 중 망치만을 의미
    - "좋아요 기능 만들어놨으니 연동해서 쓰셔요"
  - SDK는 API의 한계를 넘어서서 독자적으로 원하는 개발 가능
    - SDK >> API

## kamon
*참고: https://github.com/kamon-io/Kamon*
*참고: https://kamon.io/*
*참고: https://kamon.io/docs/latest/core/tracing/*
*참고: https://kamon.io/docs/latest/guides/how-to/log-trace-id-and-context-info/*
- **개요**
  - 개발자를 위한 관찰 툴
    - akka, play 등에 많이 쓰이는갑네
  - 기존의 로깅은 전반적인 응답 시간을 보여주는데 어려움을 겪는다
    - DB가 순차적으로 or 병렬적으로 시행되기에
  - 해결방법은 로깅을 보완하여 level, trace 뚝딱

- **TraceID**
  - logback-common.xml 에 kamon.TraceIDConverter 로 traceID를 기록한다
  - 메인 빌딩 블록은 `Span`으로 간주
  - `Span`
    - 하나의 오퍼레이션으로 충분한 정보를 가져 어떠한 트레이스가 어디에 속해있는지를 알 수 있게 지원한다. 
    - 하나의 Request에 대해 온전하게 파악할 수 있는 Span을 만들어보자 
      - 하나의 Request는 복합적으로 구성 가능
      - ![](../images/2023-08-21-kamon-span.png)
      - `val span = Kamon.spanBuilder("find-users").start()` => `span.finish()`

- **logback**
  - `logback.xml`
  ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <configuration scan="false" debug="false">
    <conversionRule
            conversionWord="traceID"
            converterClass="kamon.instrumentation.logback.tools.TraceIDConverter"/>
  
    <conversionRule
            conversionWord="spanID"
            converterClass="kamon.instrumentation.logback.tools.SpanIDConverter"/>
  
    <conversionRule
            conversionWord="contextTag"
            converterClass="kamon.instrumentation.logback.tools.ContextTagConverter"/>
  
    <conversionRule
            conversionWord="contextEntry"
            converterClass="kamon.instrumentation.logback.tools.ContextEntryConverter"/>
  
    <!-- the rest of your config... -->
  
  </configuration>
  ```
  - Trace and Span Identifier: TraceID랑 SpanID를 뚝딱 기록해두자
  ```xml
  <configuration scan="false" debug="false">
    <!-- all conversion rules from above -->
  
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
      <encoder>
        <pattern>%d | %traceID %spanID | %m%n</pattern>
      </encoder>
    </appender>
  
    <root level="DEBUG">
      <appender-ref ref="STDOUT" />
    </root>
  </configuration>
  ```
